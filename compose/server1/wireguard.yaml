# WireGuard - A modern VPN solution.

# Note: Some helpful commands
# See connections
#  docker exec -it wireguard.${HOST_NAME} bash
#  wg show

services:
  wireguard:
    container_name: wireguard.${HOST_NAME}
    hostname: wireguard.${HOST_NAME}.local
    # image: lscr.io/linuxserver/wireguard:latest # July 29, 2025 at 4:36 PM update broke WireGuard due to iptables v1.8.11 switching to nf_tables, which caused legacy PostUp rules to fail
    image: lscr.io/linuxserver/wireguard:1.0.20210914-r4-ls80
    cap_add:
      - NET_ADMIN
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
    environment:
      TZ: ${TZ}
      PGID: ${PGID}
      PUID: ${PUID}
      DOMAIN: ${DOMAINNAME}
      ALLOWEDIPS: 0.0.0.0/0,192.168.2.0/24
      PEERDNS: ${PIHOLE_PRI}
      INTERNAL_SUBNET: 192.168.10.0
      PEERS: "AndyPhone,AndyLaptop,AaronPhone,AaronLaptop,AndrewPhone,AndrewLaptop,MichellePhone,SelenaPhone,SelenaLaptop,ColinPhone,CottageDDWRT,AndyTest"
      SERVERPORT: 51820
      SERVERURL: vpn.${DOMAINNAME}      
      LOG_CONFS: true
    #network_mode: host 
    networks:
      pihole_network:
        ipv4_address: ${WIREGUARD_IP}
      mediaserver: {}
    volumes:
      - ${DOCKERDIR}/wireguard/config:/config
      - ${DOCKERDIR}/wireguard/lib/modules:/lib/modules
      - ${DOCKERDIR}/logs/wireguard:/var/log
    restart: always
    healthcheck:
      test: ["CMD", "dig", "@127.0.0.1", "google.com"]
      interval: 30s
      timeout: 10s
      retries: 3
    security_opt:
      - no-new-privileges:true
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

